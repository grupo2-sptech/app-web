<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hardware Security</title>
  <link rel="stylesheet" href="./css/dashboards.css" />
  <link rel="stylesheet" href="./assets/icons/style.css" />
  <script src="./js/dashboard.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="./js/sessao.js"></script>
</head>

<body
  onload="validarSessao(), listar(sessionStorage.SETOR, 'inp_maquina', sessionStorage.ACESSO_TOTAL),listarMaquinas(sessionStorage.SETOR, sessionStorage.ACESSO_TOTAL)">
  <!-- menu lateral -->
  <div id="menu" class="menuLateral">
    <a style="color: white; cursor: pointer">
      <div onclick="sumirMenu()" class="logo">
        <img id="logotipo" src="assets/icon/seguranca.png" alt="" />

        <!--    <img id="seta" src="https://static.wixstatic.com/media/078327_a04336273e6040239474eaaee38a18fe~mv2.gif"
            alt=""> -->
        <!--        <img  id="seta" src="https://sindiconet-files.s3.amazonaws.com/GoogleWebStories/como-funciona-energia-fotovoltaica/assets/5.gif" alt="">
 -->
      </div>
    </a>
    <div id="itens_menu" class="itens_menu">
      <div style="color: white; font-size: 12px; text-align: center;" class="nome-acao">Bem Vindo! <br><span
          id="nome_usuario"></span></div>
      <a onmouseover="mostrarAcao('dashbord')" onmouseout="ocultarAcao('dashbord')" id="link_dashboard" href="#"
        class="itensDaNav">
        <div class="icon-stats-dots ico"></div>
        <span class="nome-acao">Dashboard</span>
        <div id="dashbord" class="nome-acao-oculta">Dashboard</div>
      </a>
      <a onmouseover="mostrarAcao('perfil')" onmouseout="ocultarAcao('perfil')" class="itensDaNav">
        <div class="icon-user ico"></div>
        <samp class="nome-acao">Perfil</samp>
        <div id="perfil" class="nome-acao-oculta">Perfil</div>
      </a>
      <a onmouseover="mostrarAcao('suporte')" onmouseout="ocultarAcao('suporte')" onmouseover="mostrarAcao('suporte')"
        onmouseout="ocultarAcao('suporte')" class="itensDaNav">
        <div class="icon-support_agent ico"></div>
        <samp class="nome-acao">Suporte</samp>
        <div id="suporte" class="nome-acao-oculta">Suporte</div>
      </a>
      <a onmouseover="mostrarAcao('sair')" onmouseout="ocultarAcao('sair')" style="margin-left: -15px"
        onclick="limparSessao()" class="itensDaNav">
        <div class="icon-log-in ico"></div>
        <samp class="nome-acao">Sair</samp>
        <div id="sair" class="nome-acao-oculta">Sair</div>
      </a>
    </div>
  </div>
  <!-- DashBoard -->
  <main id="tela_principal" class="dashboard">
    <!-- Filtro -->
    <div class="superior-filtro">
      <div class="inputs">
        Selecione o Funcionário
        <select class="input_filtro" id="inp_maquina">
          <option value="" disabled selected hidden>Funcionário</option>
        </select>
      </div>
      <div id="campo_setor" class="inputs">
        Selecione o Setor
        <select class="input_filtro" id="inp_setor">
          <option value="" disabled selected hidden>Setor</option>
        </select>
      </div>

      <div class="icon-search"></div>
    </div>

    <!-- Lista Maquinas -->
    <div class="central-maquinas">

      <div class="titulo-maquinas">
        <h1 id="titulo_setor">Maquinas do setor de </h1>
      </div>


      <div id="div_funcaoMaquina" class="lista-maquinas">

      </div>


    </div>


    <div id="amostragem" class="amostragem">

      <div class="graficos">
        <span style="margin: 1%; position: absolute; font-size: 10px; font-weight: bold;"
          id="nome_usuario_maquina"></span>
        <div class="pesquisa">
          <div class="input_data">
            Insira uma data
            <input id="filtro_date" type="date" />
          </div>
          <div class="icon-search"></div>
        </div>
        <div style="display: flex;">
          <div class="graficos_esquerda">
            <h3>Uso de CPU</h3>
            <div class="grafico">
              <canvas id="myChartCpu"></canvas>
            </div>
            <h3>Uso de Memória Ram</h3>
            <div class="grafico">
              <canvas id="myChartRam"></canvas>
            </div>
          </div>
          <div class="grafico_direita">
            <div class="grafico">
              <canvas id="myChartDisco"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="detalhes_maquinas">
      </div>
    </div>
  </main>
</body>

</html>

<script>

  let inputDate = document.getElementById("filtro_date");
  let today = new Date().toISOString().split("T")[0];
  inputDate.value = today;

  let acesso_total = sessionStorage.ACESSO_TOTAL
  let nome = sessionStorage.NOME_USUARIO


  nome_usuario.innerHTML = nome;
  let campo_setor = document.getElementById('campo_setor')
  if (acesso_total == 1) {
    campo_setor.style.display = 'flex'
  }

  const myChartCpu = new Chart(document.getElementById("myChartCpu"), config);
  const myChartRam = new Chart(document.getElementById("myChartRam"), config1);
  const myChartDisco = new Chart(document.getElementById("myChartDisco"), config2);


  function obterDadosGrafico(idAquario) {
    alterarTitulo(idAquario);

    if (proximaAtualizacao != undefined) {
      clearTimeout(proximaAtualizacao);
    }

    fetch(`/medidas/ultimas/${idAquario}`, { cache: "no-store" })
      .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

            resposta.reverse();
            plotarGrafico(resposta, idAquario);
          });
        } else {
          console.error("Nenhum dado encontrado ou erro na API");
        }
      })
      .catch(function (error) {
        console.error(
          `Erro na obtenção dos dados p/ gráfico: ${error.message}`
        );
      });
  }

  let id_maquinas = [];
  function listarMaquinas(fksetor, acesso) {
    var listaMaquinas = document.getElementById("div_funcaoMaquina");
    fetch(`/dashboard/listar/${fksetor}/${acesso}`, {
      method: "GET",
    })
      .then(function (resposta) {
        resposta.json().then((maquinas) => {
          console.log(maquinas);
          if (maquinas.length == 0) {
            listaMaquinas.innerHTML = `Você ainda não possui nenhuma máquina cadastrada, cadastre a sua primeira máquina`;
          } else {
            listaMaquinas.innerHTML = "";
            maquinas.forEach((maquinas) => {
              listaMaquinas.innerHTML += `<div onclick="atualizar_grafico_tempo_real(${maquinas.maquina_id})" id = "${maquinas.maquina_id}" class="card-acao">
          <div class="icon-laptop1"></div>
          <div class="descricao-laptop">
            <div class="descricao-titulo">
              <p>${maquinas.modelo_maquina}</p>
              <p>${maquinas.nome_funcionario}</p>
              <p>${maquinas.cargo_funcionario}</p>
            </div>
            <div class="descricao-status">
              <div class="descricao-componenete">
                <div class="bolinha" id="icone-cpu${maquinas.maquina_id}"></div>
                <p>CPU</p>
              </div>
              <div class="descricao-componenete">
                <div class="bolinha" id="icone-disco${maquinas.maquina_id}"></div>
                <p>Disco</p>
              </div>
              <div class="descricao-componenete">
                <div class="bolinha" id="icone-ram${maquinas.maquina_id}"></div>
                <p>Ram</p>
              </div>
            </div>
          </div>
        </div>`;
              setInterval(() => {
                atualizar_maquina_tempo_real(maquinas.maquina_id, `icone-cpu${maquinas.maquina_id}`, `icone-ram${maquinas.maquina_id}`, `icone-disco${maquinas.maquina_id}`)
              }, 2000);
            });
          }
        });
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });
  }

  let intervalo



  function atualizar_grafico_tempo_real(id_maquina) {
    let dadoGraficoCpu = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
    let dadoGraficoRam = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
    let dadosGraficoDisco = [0, 0]
    clearInterval(intervalo);

    intervalo = setInterval(() => {
      fetch(`/dashboard/atualizar_grafico_tempo_real/${id_maquina}`, {
        method: "GET",
        cache: 'no-store'
      }).then(function (resposta) {
        resposta.json().then((informacoes) => {

          nome_usuario_maquina.innerHTML = `Monitoramento em tempo real da máquina de ${informacoes[0].nome_funcionario}`
          dadoGraficoRam.shift();
          dadoGraficoRam.push(informacoes[0].ram_ocupada_gb)
          myChartRam.data.datasets[0].data = dadoGraficoRam
          myChartRam.update();


          dadoGraficoCpu.shift();
          dadoGraficoCpu.push(informacoes[0].cpu_ocupada * 10);
          myChartCpu.data.datasets[0].data = dadoGraficoCpu
          myChartCpu.update();

          if (dadosGraficoDisco[0] == 0 || dadosGraficoDisco[1] == 0) {
            dadosGraficoDisco[0] = informacoes[0].disco_ocupado_gb
            dadosGraficoDisco[1] = informacoes[0].memoria_disponivel_gb
            myChartDisco.data.datasets[0].data = dadosGraficoDisco
            myChartDisco.update()
          }


        }).catch((erro) => {
          console.error("Erro ao converter resposta para JSON:", erro);
        });
      }).catch((erro) => {
        console.error("Erro na requisição fetch:", erro);
      });
    }, 1000);
  }


</script>